<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Zsh History Viewer</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
}
.container {
    max-width: 1600px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
}
header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    position: relative;
}
h1 { font-size: 2.5em; margin-bottom: 10px; }
.subtitle { opacity: 0.9; font-size: 1.1em; }
.about-link {
    position: absolute;
    top: 30px;
    right: 30px;
    color: white;
    text-decoration: none;
    font-size: 0.9em;
    padding: 8px 16px;
    border: 2px solid white;
    border-radius: 6px;
    transition: all 0.3s;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
}
.about-link:hover {
    background: white;
    color: #667eea;
    transform: translateY(-2px);
}
.settings-link {
    position: absolute;
    top: 30px;
    right: 150px;
    color: white;
    text-decoration: none;
    font-size: 0.9em;
    padding: 8px 16px;
    border: 2px solid white;
    border-radius: 6px;
    transition: all 0.3s;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
}
.settings-link:hover {
    background: white;
    color: #667eea;
    transform: translateY(-2px);
}
.controls {
    padding: 20px 30px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}
.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}
.filter-group label {
    font-weight: 500;
    color: #495057;
}
.search-box, input[type="date"], select {
    padding: 10px 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.95em;
    transition: all 0.3s;
}
input[type="date"]:focus, select:focus, .search-box:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
}
.btn-primary { background: #667eea; color: white; }
.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #5a6268; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-icon {
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 5px;
}
.stats {
    padding: 20px 30px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    background: #f8f9fa;
}
.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.stat-value { font-size: 1.8em; font-weight: bold; color: #667eea; }
.stat-label { color: #6c757d; margin-top: 5px; font-size: 0.9em; }
.volume-chart-container {
    padding: 20px 30px;
    background: white;
    position: relative;
}
#volumeChart {
    max-height: 200px;
}
.chart-selection-overlay {
    position: absolute;
    background: rgba(102, 126, 234, 0.2);
    border: 2px solid #667eea;
    pointer-events: none;
    display: none;
}
.content { padding: 30px; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.session-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid #667eea;
    transition: all 0.3s;
}
.session-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateX(5px);
}
.session-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}
.session-title { font-size: 1.3em; font-weight: bold; color: #333; }
.session-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.meta-item { display: flex; align-items: center; gap: 5px; color: #6c757d; font-size: 0.9em; }
.command {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 15px;
    border-radius: 6px;
    margin: 10px 0;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.85em;
    overflow-x: auto;
}
.command-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.85em;
    color: #888;
    flex-wrap: wrap;
}
.command-text { white-space: pre-wrap; word-break: break-all; }
.category-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75em;
    font-weight: 500;
    background: #667eea;
    color: white;
    margin: 2px;
}
.llm-panel {
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
}
.llm-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
.llm-result {
    background: white;
    padding: 15px;
    border-radius: 6px;
    border: 1px solid #ddd;
    max-height: 500px;
    overflow-y: auto;
    line-height: 1.6;
}
.llm-result.plain-text {
    white-space: pre-wrap;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.9em;
}
.llm-result h1 { font-size: 1.5em; margin-top: 15px; }
.llm-result h2 { font-size: 1.3em; margin-top: 12px; }
.llm-result h3 { font-size: 1.1em; margin-top: 10px; }
.llm-result p { margin: 10px 0; line-height: 1.6; }
.llm-result code {
    background: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.9em;
}
.llm-result pre {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 15px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 10px 0;
}
.llm-result pre code {
    background: none;
    color: inherit;
    padding: 0;
}
.llm-result ul, .llm-result ol {
    margin: 10px 0 10px 25px;
}
.llm-result li {
    margin: 5px 0;
    line-height: 1.6;
}
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(102, 126, 234, 0.3);
    border-radius: 50%;
    border-top-color: #667eea;
    animation: spin 1s ease-in-out infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.pattern-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}
.pattern-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #667eea;
}
.pattern-command {
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
    font-size: 0.9em;
}
.pattern-count { color: #667eea; font-size: 1.4em; font-weight: bold; }
.co-occurrence { margin-top: 10px; font-size: 0.8em; color: #6c757d; }
.empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
.empty-state-icon { font-size: 4em; margin-bottom: 20px; }
.export-dropdown { position: relative; display: inline-block; }
.dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 160px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    border-radius: 8px;
    z-index: 1;
    overflow: hidden;
}
.dropdown-content a {
    color: #333;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    transition: background 0.2s;
}
.dropdown-content a:hover { background-color: #f1f1f1; }
.export-dropdown:hover .dropdown-content { display: block; }
.filters-row {
    width: 100%;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
}
.commands-scroll-container {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 10px;
    background: #fafafa;
}
.commands-scroll-container::-webkit-scrollbar {
    width: 8px;
}
.commands-scroll-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}
.commands-scroll-container::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 4px;
}
.commands-scroll-container::-webkit-scrollbar-thumb:hover {
    background: #5568d3;
}
.keyword-highlight {
    background-color: #ffeb3b;
    font-weight: bold;
    padding: 2px 4px;
    border-radius: 2px;
}
.notes-section, .tags-section {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #dee2e6;
}
.note-item {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
    display: flex;
    justify-content: space-between;
    align-items: start;
    gap: 10px;
}
.note-text {
    flex: 1;
    color: #333;
    line-height: 1.4;
}
.note-meta {
    font-size: 0.75em;
    color: #6c757d;
    margin-top: 4px;
}
.tag-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 16px;
    margin: 4px;
    font-size: 0.85em;
    background: white;
    border: 2px solid #e0e0e0;
}
.tag-keyword { font-weight: 600; }
.tag-stars { color: #ffa500; }
.tag-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
}
.btn-small {
    padding: 4px 8px;
    font-size: 0.8em;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background: #dc3545;
    color: white;
    transition: all 0.2s;
}
.btn-small:hover { background: #c82333; }
.btn-icon-small {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #667eea;
    font-size: 1.1em;
    transition: all 0.2s;
}
.btn-icon-small:hover {
    color: #5568d3;
    transform: scale(1.1);
}
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    animation: fadeIn 0.2s;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 30px;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: slideDown 0.3s;
}
@keyframes slideDown {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.modal-header h2 { color: #333; }
.close-btn {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
}
.close-btn:hover { color: #000; }
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #495057;
}
.form-group input, .form-group textarea, .form-group select {
    width: 100%;
    padding: 10px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.95em;
    font-family: inherit;
}
.form-group textarea {
    min-height: 100px;
    resize: vertical;
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
}
.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    margin-top: 8px;
}
.color-option {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 2px solid #e0e0e0;
    cursor: pointer;
    transition: all 0.2s;
}
.color-option:hover {
    transform: scale(1.1);
    border-color: #667eea;
}
.color-option.selected {
    border-color: #667eea;
    border-width: 3px;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
}
.star-rating {
    display: flex;
    gap: 5px;
    font-size: 1.5em;
}
.star {
    cursor: pointer;
    color: #ddd;
    transition: all 0.2s;
    font-size: 1.5em;
    display: inline-block;
}
.star::before {
    content: '‚òÜ'; /* Empty star by default */
}
.star.filled {
    color: #ffa500;
}
.star.filled::before {
    content: '‚òÖ'; /* Filled star */
}
.star:hover { 
    color: #ffb733;
    transform: scale(1.2);
}
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 15px;
    align-items: center;
}
.settings-description {
    font-size: 0.85em;
    color: #6c757d;
    margin-top: 3px;
}
.settings-input {
    width: 100%;
    padding: 8px;
    border: 2px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.95em;
}
.settings-input:focus {
    outline: none;
    border-color: #667eea;
}
.settings-section {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}
.settings-section:last-child {
    border-bottom: none;
}
.pattern-item {
    display: grid;
    grid-template-columns: 2fr 3fr auto;
    gap: 10px;
    align-items: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 8px;
}
.pattern-item-category {
    font-weight: 600;
    color: #333;
}
.pattern-item-regex {
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 0.85em;
    color: #6c757d;
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üîç Zsh History Viewer</h1>
<div class="subtitle">Intelligent command history analysis with AI</div>
<a class="settings-link" onclick="openSettingsModal()">‚öôÔ∏è Settings</a>
<a class="about-link" onclick="openAboutModal()">About</a>
</header>

<div class="controls">
<div class="filters-row">
<div class="filter-group">
<label>From:</label>
<input type="date" id="startDate" onchange="applyFilters()">
</div>
<div class="filter-group">
<label>To:</label>
<input type="date" id="endDate" onchange="applyFilters()">
</div>
<div class="filter-group">
<label>Category:</label>
<select id="categoryFilter" onchange="applyFilters()">
<option value="all">All Categories</option>
<option value="version-control">Version Control</option>
<option value="build">Build</option>
<option value="file-operations">File Operations</option>
<option value="navigation">Navigation</option>
<option value="dev-tools">Dev Tools</option>
<option value="system-admin">System Admin</option>
<option value="network">Network</option>
<option value="containers">Containers</option>
<option value="database">Database</option>
<option value="editor">Editor</option>
<option value="search">Search</option>
<option value="package-manager">Package Manager</option>
<option value="other">Other</option>
</select>
</div>
<div class="filter-group">
<label>Keyword:</label>
<input type="text" class="search-box" id="keywordFilter" placeholder="Search sessions..." onkeypress="if(event.key==='Enter') applyFilters()">
</div>
<div class="filter-group">
<label>Note:</label>
<input type="text" class="search-box" id="noteFilter" placeholder="Search notes..." onkeypress="if(event.key==='Enter') applyFilters()">
</div>
<div class="filter-group">
<label>Tag:</label>
<input type="text" class="search-box" id="tagKeywordFilter" placeholder="Tag keyword..." onkeypress="if(event.key==='Enter') applyFilters()">
</div>
<div class="filter-group">
<label>Min Stars:</label>
<select id="tagStarsFilter" onchange="applyFilters()">
<option value="">Any</option>
<option value="1">1+ ‚≠ê</option>
<option value="2">2+ ‚≠ê</option>
<option value="3">3+ ‚≠ê</option>
<option value="4">4+ ‚≠ê</option>
<option value="5">5 ‚≠ê</option>
</select>
</div>
<div class="filter-group" style="margin-left: auto;">
<label>
<input type="checkbox" id="newestFirstCheckbox" checked onchange="toggleSort()" style="margin-right: 5px;">
Newest First
</label>
</div>
</div>
<div class="filters-row" style="justify-content: space-between; margin-top: 10px;">
<div style="display: flex; gap: 10px;">
<button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
<div class="export-dropdown">
<button class="btn btn-success">‚¨áÔ∏è Export</button>
<div class="dropdown-content">
<a href="#" onclick="exportData('json')">JSON</a>
<a href="#" onclick="exportData('csv')">CSV</a>
<a href="#" onclick="exportData('markdown')">Markdown</a>
<a href="#" onclick="exportData('zsh')">Zsh History</a>
</div>
</div>
</div>
<button class="btn btn-primary" onclick="applyFilters()" style="padding: 10px 30px;">‚úîÔ∏è Apply Filters</button>
</div>
</div>

<div class="stats" id="stats"></div>

<div class="volume-chart-container" id="chartContainer">
<canvas id="volumeChart"></canvas>
<div id="selectionOverlay" class="chart-selection-overlay"></div>
</div>

<div class="content">
<div id="sessionsView" class="tab-content active"></div>
</div>
</div>

<!-- Note Modal -->
<div id="noteModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2 id="noteModalTitle">Add Note</h2>
<button class="close-btn" onclick="closeNoteModal()">&times;</button>
</div>
<div class="form-group">
<label for="noteText">Note:</label>
<textarea id="noteText" placeholder="Enter your note..."></textarea>
</div>
<button class="btn btn-primary" onclick="saveNote()">Save Note</button>
</div>
</div>

<!-- Tag Modal -->
<div id="tagModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>Add Tag</h2>
<button class="close-btn" onclick="closeTagModal()">&times;</button>
</div>
<p style="color:#6c757d; margin-bottom:15px; font-size:0.9em;">Add a keyword label to this session. You can add multiple tags.</p>
<div class="form-group">
<label for="tagKeyword">Keyword:</label>
<input type="text" id="tagKeyword" placeholder="e.g., bugfix, feature, important" onkeypress="if(event.key==='Enter') saveTag()">
</div>
<div style="display:flex; gap:10px;">
<button class="btn btn-primary" onclick="saveTag()">Add Tag</button>
<button class="btn btn-secondary" onclick="saveTagAndNew()">Add & Create Another</button>
</div>
</div>
</div>

<!-- Session Metadata Modal (Color & Stars) -->
<div id="metadataModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>Set Color & Star Rating</h2>
<button class="close-btn" onclick="closeMetadataModal()">&times;</button>
</div>
<p style="color:#6c757d; margin-bottom:15px; font-size:0.9em;">Set a single color and star rating for this session.</p>
<div class="form-group">
<label>Color (optional):</label>
<div class="color-picker-grid">
<div class="color-option" style="background:#ff6b6b" data-color="#ff6b6b"></div>
<div class="color-option" style="background:#4ecdc4" data-color="#4ecdc4"></div>
<div class="color-option" style="background:#45b7d1" data-color="#45b7d1"></div>
<div class="color-option" style="background:#96ceb4" data-color="#96ceb4"></div>
<div class="color-option" style="background:#ffeaa7" data-color="#ffeaa7"></div>
<div class="color-option" style="background:#dfe6e9" data-color="#dfe6e9"></div>
<div class="color-option" style="background:#a29bfe" data-color="#a29bfe"></div>
<div class="color-option" style="background:#fd79a8" data-color="#fd79a8"></div>
</div>
<input type="hidden" id="metadataColor">
</div>
<div class="form-group">
<label>Star Rating (optional): <span id="metadataStarLabel">None</span></label>
<div class="star-rating" id="metadataStarRating">
<span class="star" data-rating="1"></span>
<span class="star" data-rating="2"></span>
<span class="star" data-rating="3"></span>
<span class="star" data-rating="4"></span>
<span class="star" data-rating="5"></span>
</div>
<input type="hidden" id="metadataStars" value="0">
</div>
<button class="btn btn-primary" onclick="saveMetadata()">Save</button>
</div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
<div class="modal-content" style="max-width: 700px;">
<div class="modal-header">
<h2>‚öôÔ∏è Settings</h2>
<button class="close-btn" onclick="closeSettingsModal()">&times;</button>
</div>
<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
<div class="settings-section">
<h3 style="margin-bottom: 15px; color: #333;">Custom Command Categories</h3>
<p style="color: #6c757d; font-size: 0.9em; margin-bottom: 15px;">
Categorize your custom commands. Custom patterns take priority over built-in patterns.
</p>
<div id="custom-patterns-list" style="margin-bottom: 15px;"></div>
<div style="margin-bottom: 15px;">
<label style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
<input type="radio" name="pattern-mode" value="simple" id="pattern-mode-simple" checked onchange="togglePatternMode()" />
<strong>Simple Mode</strong> <span style="color: #6c757d; font-size: 0.85em;">(enter command name, automatically handles ./ prefix)</span>
</label>
<label style="display: flex; align-items: center; gap: 8px;">
<input type="radio" name="pattern-mode" value="advanced" id="pattern-mode-advanced" onchange="togglePatternMode()" />
<strong>Advanced Mode</strong> <span style="color: #6c757d; font-size: 0.85em;">(regex pattern)</span>
</label>
</div>
<div style="display: grid; grid-template-columns: 2fr 3fr auto; gap: 10px; align-items: center; margin-bottom: 10px;">
<input type="text" id="new-pattern-category" class="settings-input" placeholder="Category name" />
<input type="text" id="new-pattern-command" class="settings-input" placeholder="Command name (e.g., history_viewer)" />
<button class="btn btn-primary" onclick="addCustomPattern()" style="padding: 8px 15px;">‚ûï Add</button>
</div>
<div id="pattern-help-simple" style="background: #e7f5e7; border: 1px solid #4caf50; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 0.85em;">
<strong>üí° Simple Mode:</strong><br>
Just enter the command name - we'll handle the rest!<br>
<div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
<strong>Examples:</strong><br>
‚Ä¢ Enter <code>terraform</code> ‚Üí matches <code>terraform</code> and <code>./terraform</code><br>
‚Ä¢ Enter <code>kubectl</code> ‚Üí matches <code>kubectl get pods</code><br>
‚Ä¢ Enter <code>my_script</code> ‚Üí matches <code>./my_script</code> or <code>my_script</code><br>
</div>
<div style="margin-top: 8px; color: #666; font-size: 0.9em;">
Automatically handles <code>./</code> prefix and arguments ‚úîÔ∏è
</div>
</div>
<div id="pattern-help-advanced" style="background: #fff3e0; border: 1px solid #ff9800; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 0.85em; display: none;">
<strong>üîß Advanced Mode (Regex):</strong><br>
Full control with regular expressions<br>
<div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
<strong>Common Patterns:</strong><br>
‚Ä¢ <code>^terraform\s</code> ‚Üí terraform with arguments<br>
‚Ä¢ <code>^(aws|gcloud|az)\s</code> ‚Üí multiple cloud CLIs<br>
‚Ä¢ <code>^kubectl\s+(get|describe)</code> ‚Üí specific subcommands<br>
‚Ä¢ <code>^\.?/scripts/</code> ‚Üí scripts in a directory<br>
</div>
<div style="margin-top: 8px; color: #666; font-size: 0.9em;">
<strong>Tips:</strong><br>
‚Ä¢ <code>^</code> = start of line | <code>\s</code> = whitespace | <code>|</code> = OR | <code>()</code> = grouping<br>
‚Ä¢ <a href="#" onclick="window.open('https://regex101.com', '_blank'); return false;" style="color: #ff9800;">Test patterns at regex101.com ‚Üí</a>
</div>
</div>
<details style="margin-top: 10px;">
<summary style="cursor: pointer; color: #667eea; font-size: 0.85em;">Built-in Categories</summary>
<div style="margin-top: 10px; font-size: 0.85em; color: #6c757d; line-height: 1.8;">
<strong>version-control:</strong> git, hg, svn, bzr, cvs<br>
<strong>build:</strong> make, cmake, cargo, npm, yarn, gradle, mvn, go build, gcc, etc.<br>
<strong>file-operations:</strong> cp, mv, rm, mkdir, chmod, cat, rsync, etc.<br>
<strong>navigation:</strong> cd, ls, pwd, tree, find, locate, which<br>
<strong>dev-tools:</strong> vim, code, gdb, valgrind, strace<br>
<strong>system-admin:</strong> sudo, systemctl, kill, ps, top, htop, df, du<br>
<strong>network:</strong> curl, wget, ssh, ping, dig, nc<br>
<strong>containers:</strong> docker, kubectl, helm, podman<br>
<strong>database:</strong> psql, mysql, mongo, redis-cli<br>
<strong>editor:</strong> vim, emacs, nano<br>
<strong>search:</strong> grep, ag, rg, ack<br>
<strong>package-manager:</strong> apt, brew, pip, npm, cargo
</div>
</details>
</div>

<div class="settings-section">
<h3 style="margin-bottom: 15px; color: #333;">Session Heuristics</h3>
<p style="color: #6c757d; font-size: 0.9em; margin-bottom: 20px;">
Configure how commands are grouped into sessions. Changes require a page refresh to take effect.
</p>
<div class="settings-grid">
<div>
<label><strong>Timeout (minutes)</strong></label>
<div class="settings-description">Minutes of inactivity before starting a new session</div>
</div>
<input type="number" id="setting-timeout-minutes" class="settings-input" min="1" max="1440" />

<div>
<label><strong>Directory Change Breaks Session</strong></label>
<div class="settings-description">Start new session when changing to a different project directory</div>
</div>
<label style="display: flex; align-items: center; gap: 10px;">
<input type="checkbox" id="setting-dir-change" style="width: auto;" />
<span>Enabled</span>
</label>

<div>
<label><strong>Category Change Threshold</strong></label>
<div class="settings-description">Start new session after N commands of different category (0 = disabled)</div>
</div>
<input type="number" id="setting-category-threshold" class="settings-input" min="0" max="20" />

<div>
<label><strong>Min Commands Per Session</strong></label>
<div class="settings-description">Minimum number of commands to constitute a session</div>
</div>
<input type="number" id="setting-min-commands" class="settings-input" min="1" max="50" />

<div>
<label><strong>Max Session Duration (minutes)</strong></label>
<div class="settings-description">Maximum session length (0 = unlimited)</div>
</div>
<input type="number" id="setting-max-duration" class="settings-input" min="0" max="1440" />

<div>
<label><strong>Short Break (minutes)</strong></label>
<div class="settings-description">Brief break that doesn't end session (not yet implemented)</div>
</div>
<input type="number" id="setting-short-break" class="settings-input" min="0" max="60" disabled />
</div>
</div>
</div>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
<button class="btn btn-secondary" onclick="loadSettings()">üîÑ Reset</button>
</div>
</div>
</div>

<!-- About Modal -->
<div id="aboutModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>About Zsh History Viewer</h2>
<button class="close-btn" onclick="closeAboutModal()">&times;</button>
</div>
<div style="text-align: center; padding: 20px;">
<p style="font-size: 1.1em; margin-bottom: 20px; color: #495057;">
Intelligent command history analysis with AI
</p>
<hr style="border: 0; height: 1px; background: #e0e0e0; margin: 20px 0;">
<p style="color: #6c757d; margin-bottom: 10px;">
Copyright ¬© 2026
</p>
<p style="font-size: 1.1em; font-weight: 500; color: #333; margin-bottom: 5px;">
Chris Collins
</p>
<p>
<a href="mailto:chris@hitorro.com" style="color: #667eea; text-decoration: none; font-weight: 500;">chris@hitorro.com</a>
</p>
</div>
</div>
</div>

<script>
let sessions = [];
let volumeData = [];
let volumeChart = null;
let currentSort = 'desc'; // default: newest first
let filters = {
    startDate: '',
    endDate: '',
    category: 'all',
    keyword: '',
    noteSearch: '',
    tagKeyword: '',
    tagStars: ''
};
let dragStart = null;
let dragEnd = null;
let isDragging = false;
let activeLLMPanels = new Set();

marked.setOptions({
    breaks: true,
    gfm: true
});

async function fetchData() {
    try {
        // Build query parameters with proper names for backend
        const params = new URLSearchParams();
        params.append('sort', currentSort);
        
        if (filters.startDate) {
            params.append('start_date', filters.startDate);
        }
        if (filters.endDate) {
            params.append('end_date', filters.endDate);
        }
        if (filters.category && filters.category !== 'all') {
            params.append('category', filters.category);
        }
        if (filters.keyword) {
            params.append('keyword', filters.keyword);
        }
        if (filters.noteSearch) {
            params.append('note_search', filters.noteSearch);
        }
        if (filters.tagKeyword) {
            params.append('tag_keyword', filters.tagKeyword);
        }
        if (filters.tagStars) {
            params.append('tag_stars', filters.tagStars);
        }
        
        console.log('Fetching with filters:', params.toString());
        
        const [sessionsRes, statsRes, volumeRes] = await Promise.all([
            fetch('/api/sessions?' + params.toString()),
            fetch('/api/stats'),
            fetch('/api/volume')
        ]);
        
        sessions = await sessionsRes.json();
        const stats = await statsRes.json();
        volumeData = await volumeRes.json();
        
        console.log('Received sessions:', sessions.length);
        
        renderStats(stats);
        renderVolumeChart();
        
        // Don't re-render sessions if LLM panels are open (would destroy results)
        if (activeLLMPanels.size === 0) {
            renderSessions();
        } else {
            console.log('Skipping session re-render, LLM panels active:', activeLLMPanels.size);
        }
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

async function refreshData() {
    await fetch('/api/refresh');
    await fetchData();
}

function renderStats(stats) {
    const el = document.getElementById('stats');
    const filtered = sessions.length;
    const total = stats.total_sessions;
    el.innerHTML = `
        <div class="stat-card">
            <div class="stat-value">${filtered}</div>
            <div class="stat-label">Filtered Sessions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${total}</div>
            <div class="stat-label">Total Sessions</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${stats.total_commands}</div>
            <div class="stat-label">Total Commands</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${new Date(stats.last_updated).toLocaleTimeString()}</div>
            <div class="stat-label">Last Updated</div>
        </div>
    `;
}

function renderVolumeChart() {
    const ctx = document.getElementById('volumeChart').getContext('2d');
    
    if (volumeChart) {
        volumeChart.destroy();
    }
    
    volumeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: volumeData.map(d => d.date),
            datasets: [{
                label: 'Commands per Day',
                data: volumeData.map(d => d.count),
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onHover: (event, activeElements) => {
                event.native.target.style.cursor = activeElements.length > 0 ? 'pointer' : 'crosshair';
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Command Volume Over Time (Click bar or drag to select date range)'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Commands: ${context.parsed.y}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
    
    // Add drag selection handlers
    const canvas = document.getElementById('volumeChart');
    const overlay = document.getElementById('selectionOverlay');
    const container = document.getElementById('chartContainer');
    
    let dragStartX = 0;
    
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const dataX = volumeChart.scales.x.getValueForPixel(x);
        if (dataX >= 0 && dataX < volumeData.length) {
            isDragging = true;
            dragStart = Math.round(dataX);
            dragEnd = dragStart;
            dragStartX = e.clientX;
            
            // Position overlay
            const containerRect = container.getBoundingClientRect();
            overlay.style.left = (e.clientX - containerRect.left) + 'px';
            overlay.style.top = '0';
            overlay.style.width = '0';
            overlay.style.height = canvas.offsetHeight + 'px';
            overlay.style.display = 'block';
        }
    });
    
    canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const dataX = volumeChart.scales.x.getValueForPixel(x);
        if (dataX >= 0 && dataX < volumeData.length) {
            dragEnd = Math.round(dataX);
            
            // Update overlay
            const containerRect = container.getBoundingClientRect();
            const currentX = e.clientX - containerRect.left;
            const startX = dragStartX - containerRect.left;
            
            if (currentX > startX) {
                overlay.style.left = startX + 'px';
                overlay.style.width = (currentX - startX) + 'px';
            } else {
                overlay.style.left = currentX + 'px';
                overlay.style.width = (startX - currentX) + 'px';
            }
        }
    });
    
    canvas.addEventListener('mouseup', (e) => {
        overlay.style.display = 'none';
        
        if (!isDragging) {
            // Simple click - select single date
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const dataX = volumeChart.scales.x.getValueForPixel(x);
            if (dataX >= 0 && dataX < volumeData.length) {
                const date = volumeData[Math.round(dataX)].date;
                document.getElementById('startDate').value = date;
                document.getElementById('endDate').value = date;
                applyFilters();
            }
        } else {
            // Drag selection - select range
            isDragging = false;
            if (dragStart !== null && dragEnd !== null) {
                const start = Math.min(dragStart, dragEnd);
                const end = Math.max(dragStart, dragEnd);
                document.getElementById('startDate').value = volumeData[start].date;
                document.getElementById('endDate').value = volumeData[end].date;
                applyFilters();
            }
            dragStart = null;
            dragEnd = null;
        }
    });
    
    canvas.addEventListener('mouseleave', () => {
        overlay.style.display = 'none';
        isDragging = false;
        dragStart = null;
        dragEnd = null;
    });
}

function renderSessions() {
    const container = document.getElementById('sessionsView');
    if (sessions.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>No sessions found</h3><p>Try adjusting your filters</p></div>';
        return;
    }
    
    // Determine if we should show all commands (when keyword search is active)
    const shouldShowAll = filters.keyword && filters.keyword.trim() !== '';
    
    container.innerHTML = sessions.map(session => {
        // Check if this session has matches and where the first match is
        let firstMatchIndex = -1;
        if (shouldShowAll) {
            const tokens = filters.keyword.toLowerCase().split(/\s+/).filter(t => t);
            for (let i = 0; i < session.commands.length; i++) {
                const cmd = session.commands[i];
                const allTokensMatch = tokens.every(token => 
                    cmd.command.toLowerCase().includes(token)
                );
                if (allTokensMatch) {
                    firstMatchIndex = i;
                    break;
                }
            }
        }
        
        return `
        <div class="session-card">
            <div class="session-header">
                <div class="session-title">Session #${session.id}: ${escapeHtml(session.description)}</div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn btn-icon-small" onclick="openNoteModal('session', ${session.id})" title="Add Note">üìù</button>
                    <button class="btn btn-icon-small" onclick="openTagModal('session', ${session.id})" title="Add Tag">üè∑Ô∏è</button>
                    <button class="btn btn-icon-small" onclick="openMetadataModal('session', ${session.id})" title="Set Color & Stars">üé®</button>
                    <button class="btn btn-secondary" onclick="toggleLLMPanel('session-${session.id}')">ü§ñ AI Analyze</button>
                    <button class="btn btn-success" onclick="toggleExportPanel('session-${session.id}')">üì• Export</button>
                </div>
            </div>
            <div class="session-meta">
                <div class="meta-item">üìÖ ${new Date(session.start_time).toLocaleString()}</div>
                <div class="meta-item">‚è±Ô∏è ${formatDuration(session.duration)}</div>
                <div class="meta-item">üíª ${session.commands.length} commands</div>
                <div class="meta-item">üìÅ ${session.directories.length} directories</div>
                ${firstMatchIndex >= 0 ? `<div class="meta-item" style="color:#667eea; font-weight:bold;">üìç Match at command #${firstMatchIndex + 1}</div>` : ''}
            </div>
            <div>
                ${Object.entries(session.categories || {}).map(([cat, count]) => 
                    `<span class="category-badge">${cat}: ${count}</span>`
                ).join(' ')}
            </div>
            ${renderSessionMetadata(session.metadata)}
            ${renderNotes(session.notes || [], 'session', session.id)}
            ${renderTags(session.tags || [], 'session', session.id)}
            <div id="llm-panel-session-${session.id}" style="display:none;">
                <div class="llm-panel">
                    <div style="margin-bottom:15px;">
                        <button class="btn btn-primary" onclick="analyzeSession(${session.id}, 'explain')">Explain This Session</button>
                    </div>
                    <div style="border-top:1px solid #ddd; padding-top:15px;">
                        <label style="display:block; margin-bottom:5px; font-weight:500;">Or ask a custom question:</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="custom-prompt-${session.id}" placeholder="e.g., What files were modified? What was I debugging?" 
                                   style="flex:1; padding:10px; border:2px solid #e0e0e0; border-radius:6px;" 
                                   onkeypress="if(event.key==='Enter') analyzeSessionCustom(${session.id})" />
                            <button class="btn btn-primary" onclick="analyzeSessionCustom(${session.id})">Ask</button>
                        </div>
                    </div>
                    <div id="llm-result-session-${session.id}" style="margin-top:15px; min-height:50px;"></div>
                </div>
            </div>
            <div id="export-panel-session-${session.id}" style="display:none;">
                <div style="background:#e7f3ff; border:2px solid #667eea; border-radius:8px; padding:20px; margin-top:15px;">
                    <h3 style="margin-bottom:10px;">Export Commands</h3>
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="exportSessionAs(${session.id}, 'bash')">Bash Script</button>
                        <button class="btn btn-primary" onclick="exportSessionAs(${session.id}, 'python')">Python Script</button>
                        <button class="btn btn-primary" onclick="exportSessionAs(${session.id}, 'java')">Java Class</button>
                        <button class="btn btn-primary" onclick="exportSessionAs(${session.id}, 'go')">Go Program</button>
                    </div>
                </div>
            </div>
            <div id="commands-container-${session.id}" class="commands-scroll-container" style="margin-top:15px;">
                ${renderSessionCommands(session, shouldShowAll)}
            </div>
            ${!shouldShowAll && session.commands.length > 5 ? `
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn btn-secondary" onclick="showAllCommands(${session.id})">
                        Show all ${session.commands.length} commands
                    </button>
                </div>
            ` : ''}
        </div>
    `;
    }).join('');
    
    // After rendering, scroll to first match if keyword search is active
    if (filters.keyword) {
        setTimeout(() => scrollToFirstMatch(), 100);
    }
}

function renderSessionCommands(session, showAll) {
    const commandsToShow = showAll ? session.commands : session.commands.slice(0, 5);
    return commandsToShow.map(cmd => renderCommand(cmd, session.id)).join('');
}

function renderCommand(cmd, sessionId) {
    let commandText = escapeHtml(cmd.command);
    let hasMatch = false;
    
    // Highlight keywords if search is active
    if (filters.keyword) {
        const tokens = filters.keyword.toLowerCase().split(/\s+/);
        tokens.forEach(token => {
            if (token) {
                const regex = new RegExp(`(${escapeRegex(token)})`, 'gi');
                if (regex.test(cmd.command)) {
                    hasMatch = true;
                    commandText = commandText.replace(regex, '<span class="keyword-highlight">$1</span>');
                }
            }
        });
    }
    
    const matchClass = hasMatch ? ' data-has-match="true"' : '';
    const matchId = hasMatch ? ` id="match-${sessionId}-${cmd.timestamp}"` : '';
    
    return `
        <div class="command"${matchClass}${matchId}>
            <div class="command-header">
                <span>${new Date(cmd.timestamp).toLocaleString()}</span>
                <span>${escapeHtml(cmd.directory)}</span>
                <span class="category-badge">${cmd.category}</span>
            </div>
            <div class="command-text">${commandText}</div>
        </div>
    `;
}

function formatDuration(nanoseconds) {
    const seconds = Math.floor(nanoseconds / 1e9);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    
    if (hours > 0) return `${hours}h ${minutes % 60}m`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function scrollToFirstMatch() {
    // Find all session cards
    const sessionCards = document.querySelectorAll('.session-card');
    
    sessionCards.forEach(card => {
        // Find the first command with a match in this session
        const firstMatch = card.querySelector('[data-has-match="true"]');
        if (firstMatch) {
            // Get the scrollable container
            const container = card.querySelector('.commands-scroll-container');
            if (container) {
                // Scroll to the first match
                const offsetTop = firstMatch.offsetTop - container.offsetTop;
                container.scrollTop = offsetTop - 10; // 10px padding from top
            }
        }
    });
}

function toggleLLMPanel(id) {
    const panel = document.getElementById(`llm-panel-${id}`);
    const exportPanel = document.getElementById(`export-panel-${id}`);
    const isOpening = panel.style.display === 'none';
    
    panel.style.display = isOpening ? 'block' : 'none';
    if (exportPanel) exportPanel.style.display = 'none';
    
    // Track active panels to prevent auto-refresh from destroying results
    if (isOpening) {
        activeLLMPanels.add(id);
    } else {
        activeLLMPanels.delete(id);
    }
}

function toggleExportPanel(id) {
    const panel = document.getElementById(`export-panel-${id}`);
    const llmPanel = document.getElementById(`llm-panel-${id}`);
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (llmPanel) llmPanel.style.display = 'none';
}

async function analyzeSession(sessionId, action) {
    console.log('analyzeSession called:', sessionId, action);
    const resultEl = document.getElementById(`llm-result-session-${sessionId}`);
    
    if (!resultEl) {
        console.error('Result element not found!');
        return;
    }
    
    console.log('Result element found:', resultEl);
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div class="loading"></div> Analyzing with AI...';
    
    try {
        console.log('Sending request to /api/llm/analyze');
        const response = await fetch('/api/llm/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({session_id: sessionId, action})
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.error) {
            console.log('Error in response:', data.error);
            resultEl.innerHTML = `<div class="llm-result" style="color:red; display:block !important;">${escapeHtml(data.error)}</div>`;
        } else if (data.result) {
            // Render as markdown for better readability
            const markdownHtml = marked.parse(data.result);
            console.log('Setting markdown result, length:', markdownHtml.length);
            resultEl.innerHTML = `<div class="llm-result" style="display:block !important; background:white; padding:15px; border:2px solid #667eea; white-space:normal;">${markdownHtml}</div>`;
            console.log('Result HTML set');
        } else {
            console.error('No result or error in response');
            resultEl.innerHTML = `<div class="llm-result" style="color:red;">No response received</div>`;
        }
    } catch (error) {
        console.error('Exception:', error);
        resultEl.innerHTML = `<div class="llm-result" style="color:red;">Error: ${error.message}</div>`;
    }
}

async function analyzeSessionCustom(sessionId) {
    const promptInput = document.getElementById(`custom-prompt-${sessionId}`);
    const prompt = promptInput.value.trim();
    
    if (!prompt) {
        alert('Please enter a prompt');
        return;
    }
    
    const resultEl = document.getElementById(`llm-result-session-${sessionId}`);
    resultEl.style.display = 'block';
    resultEl.innerHTML = '<div class="loading"></div> Processing...';
    
    const session = sessions.find(s => s.id === sessionId);
    if (!session) return;
    
    const commands = session.commands.map(cmd => cmd.command).join('\n');
    const fullPrompt = `${prompt}\n\nCommands:\n${commands}`;
    
    try {
        const response = await fetch('/api/llm/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                session_id: sessionId,
                action: 'custom',
                custom_prompt: fullPrompt
            })
        });
        
        const data = await response.json();
        if (data.error) {
            resultEl.innerHTML = `<div class="llm-result" style="color:red;">${escapeHtml(data.error)}</div>`;
        } else {
            // Show as plain text with proper formatting (custom prompts)
            const result = escapeHtml(data.result);
            resultEl.innerHTML = `<div class="llm-result plain-text" style="display:block !important; background:white; padding:15px; border:2px solid #667eea;">${result}</div>`;
            console.log('Custom LLM result displayed, length:', result.length);
        }
    } catch (error) {
        resultEl.innerHTML = `<div class="llm-result" style="color:red;">Error: ${error.message}</div>`;
    }
}

function applyFilters() {
    filters.startDate = document.getElementById('startDate').value;
    filters.endDate = document.getElementById('endDate').value;
    filters.category = document.getElementById('categoryFilter').value;
    filters.keyword = document.getElementById('keywordFilter').value;
    filters.noteSearch = document.getElementById('noteFilter').value;
    filters.tagKeyword = document.getElementById('tagKeywordFilter').value;
    filters.tagStars = document.getElementById('tagStarsFilter').value;
    
    // Close all LLM panels when applying filters so sessions can re-render
    activeLLMPanels.clear();
    
    fetchData();
}

function clearFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('keywordFilter').value = '';
    document.getElementById('noteFilter').value = '';
    document.getElementById('tagKeywordFilter').value = '';
    document.getElementById('tagStarsFilter').value = '';
    document.getElementById('newestFirstCheckbox').checked = true;
    filters = { startDate: '', endDate: '', category: 'all', keyword: '', noteSearch: '', tagKeyword: '', tagStars: '' };
    currentSort = 'desc';
    
    // Close all LLM panels when clearing filters
    activeLLMPanels.clear();
    
    fetchData();
}

function toggleSort() {
    const checkbox = document.getElementById('newestFirstCheckbox');
    currentSort = checkbox.checked ? 'desc' : 'asc';
    
    // Close all LLM panels when toggling sort
    activeLLMPanels.clear();
    
    fetchData();
}

function exportData(format) {
    const params = new URLSearchParams({
        format,
        ...filters
    });
    window.location.href = `/api/export?${params.toString()}`;
}

function showAllCommands(sessionId) {
    console.log('showAllCommands called for session:', sessionId);
    const session = sessions.find(s => s.id === sessionId);
    if (!session) {
        console.error('Session not found:', sessionId);
        return;
    }
    
    console.log('Session found with', session.commands.length, 'commands');
    
    // Find the commands container by ID
    const commandsContainer = document.getElementById(`commands-container-${sessionId}`);
    if (!commandsContainer) {
        console.error('Commands container not found for session:', sessionId);
        return;
    }
    
    console.log('Container found, rendering all commands');
    
    // Render all commands
    const commandsHtml = renderSessionCommands(session, true);
    console.log('Generated HTML length:', commandsHtml.length);
    commandsContainer.innerHTML = commandsHtml;
    console.log('Commands rendered successfully');
    
    // Hide the "Show all" button
    const button = document.querySelector(`button[onclick="showAllCommands(${sessionId})"]`);
    if (button && button.parentElement) {
        button.parentElement.style.display = 'none';
    }
    
    // Scroll to first match if keyword search is active
    if (filters.keyword) {
        setTimeout(() => scrollToFirstMatch(), 100);
    }
}

function exportSessionAs(sessionId, language) {
    const session = sessions.find(s => s.id === sessionId);
    if (!session) return;
    
    const commands = session.commands.map(cmd => cmd.command);
    let content, filename;
    
    switch(language) {
        case 'bash':
            content = generateBashScript(commands, session);
            filename = `session_${sessionId}.sh`;
            break;
        case 'python':
            content = generatePythonScript(commands, session);
            filename = `session_${sessionId}.py`;
            break;
        case 'java':
            content = generateJavaClass(commands, session);
            filename = `Session${sessionId}.java`;
            break;
        case 'go':
            content = generateGoProgram(commands, session);
            filename = `session_${sessionId}.go`;
            break;
    }
    
    downloadFile(content, filename);
}

function generateBashScript(commands, session) {
    return `#!/bin/bash
# Generated from Session #${session.id}: ${session.description}
# Date: ${new Date().toLocaleString()}

set -e  # Exit on error

${commands.map(cmd => `# ${new Date(session.start_time).toLocaleDateString()}
${cmd}`).join('\n\n')}
`;
}

function generatePythonScript(commands, session) {
    return `#!/usr/bin/env python3
"""
Generated from Session #${session.id}: ${session.description}
Date: ${new Date().toLocaleString()}
"""

import subprocess
import sys

def run_command(cmd):
    """Execute a shell command and handle errors."""
    try:
        result = subprocess.run(cmd, shell=True, check=True, 
                              capture_output=True, text=True)
        print(result.stdout)
        return result.returncode
    except subprocess.CalledProcessError as e:
        print(f"Error executing: {cmd}", file=sys.stderr)
        print(e.stderr, file=sys.stderr)
        return e.returncode

if __name__ == "__main__":
${commands.map(cmd => `    run_command(${JSON.stringify(cmd)})`).join('\n')}
`;
}

function generateJavaClass(commands, session) {
    return `import java.io.*;
import java.util.*;

/**
 * Generated from Session #${session.id}: ${session.description}
 * Date: ${new Date().toLocaleString()}
 */
public class Session${session.id} {
    
    public static void main(String[] args) {
        List<String> commands = Arrays.asList(
${commands.map(cmd => `            ${JSON.stringify(cmd)}`).join(',\n')}
        );
        
        for (String cmd : commands) {
            executeCommand(cmd);
        }
    }
    
    private static void executeCommand(String command) {
        try {
            ProcessBuilder pb = new ProcessBuilder("/bin/sh", "-c", command);
            pb.redirectErrorStream(true);
            Process process = pb.start();
            
            BufferedReader reader = new BufferedReader(
                new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            
            int exitCode = process.waitFor();
            if (exitCode != 0) {
                System.err.println("Command failed with exit code " + exitCode);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
`;
}

function generateGoProgram(commands, session) {
    return `package main

import (
	"fmt"
	"os"
	"os/exec"
)

// Generated from Session #${session.id}: ${session.description}
// Date: ${new Date().toLocaleString()}

func main() {
	commands := []string{
${commands.map(cmd => `		${JSON.stringify(cmd)},`).join('\n')}
	}
	
	for _, cmd := range commands {
		if err := executeCommand(cmd); err != nil {
			fmt.Fprintf(os.Stderr, "Error executing command: %v\\n", err)
		}
	}
}

func executeCommand(command string) error {
	cmd := exec.Command("/bin/sh", "-c", command)
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr
	return cmd.Run()
}
`;
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

// Notes, Tags, and Metadata functionality
let currentNoteTarget = {type: '', id: 0};
let currentTagTarget = {type: '', id: 0};
let currentMetadataTarget = {type: '', id: 0};

function renderNotes(notes, targetType, targetId) {
    if (!notes || notes.length === 0) return '';
    return `
        <div class="notes-section">
            <strong style="color:#667eea;">üìù Notes:</strong>
            ${notes.map(note => `
                <div class="note-item">
                    <div>
                        <div class="note-text">${escapeHtml(note.text)}</div>
                        <div class="note-meta">Added ${new Date(note.created_at).toLocaleString()}</div>
                    </div>
                    <button class="btn-small" onclick="deleteNote('${note.id}')">&times;</button>
                </div>
            `).join('')}
        </div>
    `;
}

function renderTags(tags, targetType, targetId) {
    if (!tags || tags.length === 0) return '';
    return `
        <div class="tags-section">
            <strong style="color:#667eea;">üè∑Ô∏è Tags:</strong>
            ${tags.map(tag => `
                <span class="tag-item">
                    <span class="tag-keyword">${escapeHtml(tag.keyword)}</span>
                    <button class="btn-small" onclick="deleteTag('${tag.id}')" style="margin-left:6px;">&times;</button>
                </span>
            `).join('')}
        </div>
    `;
}

function renderSessionMetadata(metadata) {
    if (!metadata || (!metadata.color_code && !metadata.star_rating)) return '';
    let parts = [];
    if (metadata.color_code) parts.push(`<span class="tag-color-dot" style="background:${metadata.color_code}; margin-right:8px;"></span>`);
    if (metadata.star_rating > 0) parts.push(`<span class="tag-stars">${'‚≠ê'.repeat(metadata.star_rating)}</span>`);
    return `
        <div class="tags-section" style="border-top:none; margin-top:8px; padding-top:0;">
            <strong style="color:#667eea;">Session: </strong>
            ${parts.join('')}
        </div>
    `;
}

function openNoteModal(type, id) {
    currentNoteTarget = {type, id};
    document.getElementById('noteModalTitle').textContent = 'Add Note';
    document.getElementById('noteText').value = '';
    document.getElementById('noteModal').style.display = 'block';
}

function closeNoteModal() {
    document.getElementById('noteModal').style.display = 'none';
}

function openTagModal(type, id) {
    currentTagTarget = {type, id};
    document.getElementById('tagKeyword').value = '';
    document.getElementById('tagModal').style.display = 'block';
    // Focus on input
    setTimeout(() => document.getElementById('tagKeyword').focus(), 100);
}

function closeTagModal() {
    document.getElementById('tagModal').style.display = 'none';
}

function openMetadataModal(type, id) {
    currentMetadataTarget = {type, id};
    
    // Get current metadata for this session
    const session = sessions.find(s => s.id === id && type === 'session');
    const metadata = session?.metadata;
    
    // Set current values
    document.getElementById('metadataColor').value = metadata?.color_code || '';
    document.getElementById('metadataStars').value = metadata?.star_rating || 0;
    
    // Update UI
    document.getElementById('metadataStarLabel').textContent = 
        (metadata?.star_rating > 0) ? `${metadata.star_rating} star${metadata.star_rating > 1 ? 's' : ''}` : 'None';
    
    // Reset/set color selection
    document.querySelectorAll('#metadataModal .color-option').forEach(el => {
        if (el.dataset.color === metadata?.color_code) {
            el.classList.add('selected');
        } else {
            el.classList.remove('selected');
        }
    });
    
    // Reset/set star rating
    document.querySelectorAll('#metadataModal .star').forEach((s, index) => {
        if (index < (metadata?.star_rating || 0)) {
            s.classList.add('filled');
        } else {
            s.classList.remove('filled');
        }
    });
    
    // Setup star rating listeners for metadata modal
    setupMetadataStarRating();
    
    document.getElementById('metadataModal').style.display = 'block';
}

function closeMetadataModal() {
    document.getElementById('metadataModal').style.display = 'none';
}

function openAboutModal() {
    document.getElementById('aboutModal').style.display = 'block';
}

function closeAboutModal() {
    document.getElementById('aboutModal').style.display = 'none';
}

function openSettingsModal() {
    document.getElementById('settingsModal').style.display = 'block';
    loadSettings();
}

function closeSettingsModal() {
    document.getElementById('settingsModal').style.display = 'none';
}

let customPatterns = [];

async function loadSettings() {
    try {
        const response = await fetch('/api/config');
        if (!response.ok) {
            throw new Error('Failed to load config');
        }
        const config = await response.json();
        
        // Populate form fields
        document.getElementById('setting-timeout-minutes').value = config.session_heuristics.timeout_minutes || 30;
        document.getElementById('setting-dir-change').checked = config.session_heuristics.directory_change_breaks_session || false;
        document.getElementById('setting-category-threshold').value = config.session_heuristics.category_change_threshold || 0;
        document.getElementById('setting-min-commands').value = config.session_heuristics.min_commands_per_session || 1;
        document.getElementById('setting-max-duration').value = config.session_heuristics.max_session_duration_minutes || 0;
        document.getElementById('setting-short-break').value = config.session_heuristics.short_break_minutes || 5;
        
        // Load custom patterns
        customPatterns = config.custom_category_patterns || [];
        renderCustomPatterns();
    } catch (error) {
        console.error('Error loading settings:', error);
        alert('Failed to load settings: ' + error.message);
    }
}

function renderCustomPatterns() {
    const container = document.getElementById('custom-patterns-list');
    if (customPatterns.length === 0) {
        container.innerHTML = '<div style="color: #6c757d; font-size: 0.9em; font-style: italic;">No custom patterns defined</div>';
        return;
    }
    
    container.innerHTML = customPatterns.map((pattern, index) => {
        // Try to detect if this is a simple pattern
        const isSimplePattern = pattern.pattern.match(/^\^[^(|\[\\]+\(\\s\|\$\)$/);
        let displayText = pattern.pattern;
        
        if (isSimplePattern) {
            // Extract command name from pattern like ^command(\s|$)
            const match = pattern.pattern.match(/^\^([^(]+)/);
            if (match) {
                displayText = `<strong>${escapeHtml(match[1])}</strong> <span style="color: #999; font-size: 0.8em;">(matches command)</span>`;
            }
        } else {
            displayText = `<code>${escapeHtml(pattern.pattern)}</code> <span style="color: #999; font-size: 0.8em;">(regex)</span>`;
        }
        
        return `
            <div class="pattern-item">
                <div class="pattern-item-category">${escapeHtml(pattern.category)}</div>
                <div class="pattern-item-regex">${displayText}</div>
                <button class="btn-small" onclick="removeCustomPattern(${index})">‚ùå Remove</button>
            </div>
        `;
    }).join('');
}

function togglePatternMode() {
    const isSimple = document.getElementById('pattern-mode-simple').checked;
    const inputField = document.getElementById('new-pattern-command');
    const helpSimple = document.getElementById('pattern-help-simple');
    const helpAdvanced = document.getElementById('pattern-help-advanced');
    
    if (isSimple) {
        inputField.placeholder = 'Command name (e.g., history_viewer)';
        helpSimple.style.display = 'block';
        helpAdvanced.style.display = 'none';
    } else {
        inputField.placeholder = 'Regex pattern (e.g., ^terraform\\s)';
        helpSimple.style.display = 'none';
        helpAdvanced.style.display = 'block';
    }
}

function addCustomPattern() {
    const category = document.getElementById('new-pattern-category').value.trim();
    const input = document.getElementById('new-pattern-command').value.trim();
    const isSimple = document.getElementById('pattern-mode-simple').checked;
    
    if (!category || !input) {
        alert('Please enter both category and command/pattern');
        return;
    }
    
    // Convert simple command to regex pattern
    let pattern = input;
    if (isSimple) {
        // Escape special regex characters in the command name
        const escaped = input.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Create pattern that matches command with or without arguments
        // Also handles ./ prefix for local executables
        // Use single backslashes here - JSON.stringify will escape them to double
        pattern = `^(\./)?${escaped}(\s|$)`;
    }
    
    // Validate regex
    try {
        new RegExp(pattern);
    } catch (e) {
        alert('Invalid regex pattern: ' + e.message);
        return;
    }
    
    customPatterns.push({ category, pattern });
    renderCustomPatterns();
    
    // Clear inputs
    document.getElementById('new-pattern-category').value = '';
    document.getElementById('new-pattern-command').value = '';
}

function removeCustomPattern(index) {
    customPatterns.splice(index, 1);
    renderCustomPatterns();
}

async function saveSettings() {
    try {
        // Get current config first
        const response = await fetch('/api/config');
        if (!response.ok) {
            throw new Error('Failed to load current config');
        }
        const config = await response.json();
        
        // Update session heuristics
        config.session_heuristics = {
            timeout_minutes: parseInt(document.getElementById('setting-timeout-minutes').value) || 30,
            directory_change_breaks_session: document.getElementById('setting-dir-change').checked,
            category_change_threshold: parseInt(document.getElementById('setting-category-threshold').value) || 0,
            min_commands_per_session: parseInt(document.getElementById('setting-min-commands').value) || 1,
            max_session_duration_minutes: parseInt(document.getElementById('setting-max-duration').value) || 0,
            short_break_minutes: parseInt(document.getElementById('setting-short-break').value) || 5
        };
        
        // Update custom category patterns
        config.custom_category_patterns = customPatterns.length > 0 ? customPatterns : null;
        
        // Save config
        const saveResponse = await fetch('/api/config', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        if (!saveResponse.ok) {
            const error = await saveResponse.text();
            throw new Error('Failed to save config: ' + error);
        }
        
        alert('Settings saved successfully! Please refresh the page for changes to take effect.');
        closeSettingsModal();
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings: ' + error.message);
    }
}

async function saveNote() {
    const text = document.getElementById('noteText').value.trim();
    if (!text) {
        alert('Please enter a note');
        return;
    }
    
    try {
        const response = await fetch('/api/metadata/notes', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                target_type: currentNoteTarget.type,
                target_id: currentNoteTarget.id,
                text: text
            })
        });
        
        if (response.ok) {
            closeNoteModal();
            fetchData(); // Refresh to show new note
        } else {
            const error = await response.text();
            alert('Failed to save note: ' + error);
        }
    } catch (error) {
        alert('Error saving note: ' + error.message);
    }
}

async function deleteNote(noteId) {
    if (!confirm('Delete this note?')) return;
    
    try {
        const response = await fetch(`/api/metadata/notes?note_id=${noteId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            fetchData(); // Refresh to remove note
        } else {
            alert('Failed to delete note');
        }
    } catch (error) {
        alert('Error deleting note: ' + error.message);
    }
}

async function saveTag(keepOpen = false) {
    const keyword = document.getElementById('tagKeyword').value.trim();
    
    if (!keyword) {
        alert('Please enter a keyword');
        return;
    }
    
    try {
        const response = await fetch('/api/metadata/tags', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                target_type: currentTagTarget.type,
                target_id: currentTagTarget.id,
                keyword: keyword
            })
        });
        
        if (response.ok) {
            if (keepOpen) {
                // Reset form for next tag
                document.getElementById('tagKeyword').value = '';
                document.getElementById('tagKeyword').focus();
            } else {
                closeTagModal();
            }
            fetchData(); // Refresh to show new tag
        } else {
            const error = await response.text();
            alert('Failed to save tag: ' + error);
        }
    } catch (error) {
        alert('Error saving tag: ' + error.message);
    }
}

async function saveTagAndNew() {
    await saveTag(true);
}

async function saveMetadata() {
    const colorCode = document.getElementById('metadataColor').value;
    const starRating = parseInt(document.getElementById('metadataStars').value) || 0;
    
    try {
        const response = await fetch('/api/metadata/session', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                target_type: currentMetadataTarget.type,
                target_id: currentMetadataTarget.id,
                color_code: colorCode,
                star_rating: starRating
            })
        });
        
        if (response.ok) {
            closeMetadataModal();
            fetchData(); // Refresh to show updated metadata
        } else {
            const error = await response.text();
            alert('Failed to save metadata: ' + error);
        }
    } catch (error) {
        alert('Error saving metadata: ' + error.message);
    }
}

async function deleteTag(tagId) {
    if (!confirm('Delete this tag?')) return;
    
    try {
        const response = await fetch(`/api/metadata/tags?tag_id=${tagId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            fetchData(); // Refresh to remove tag
        } else {
            alert('Failed to delete tag');
        }
    } catch (error) {
        alert('Error deleting tag: ' + error.message);
    }
}

function setupMetadataStarRating() {
    const container = document.getElementById('metadataStarRating');
    const stars = container.querySelectorAll('.star');
    
    stars.forEach(star => {
        // Remove old listeners by cloning
        const newStar = star.cloneNode(true);
        star.parentNode.replaceChild(newStar, star);
    });
    
    // Re-query after cloning
    container.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.dataset.rating);
            const currentRating = parseInt(document.getElementById('metadataStars').value);
            
            // Toggle: if clicking the same rating, set to 0
            const newRating = (currentRating === rating) ? 0 : rating;
            document.getElementById('metadataStars').value = newRating;
            
            // Update label
            document.getElementById('metadataStarLabel').textContent = newRating === 0 ? 'None' : `${newRating} star${newRating > 1 ? 's' : ''}`;
            
            // Update visual state
            container.querySelectorAll('.star').forEach((s, index) => {
                if (index < newRating) {
                    s.classList.add('filled');
                } else {
                    s.classList.remove('filled');
                }
            });
        });
        
        // Hover effect
        star.addEventListener('mouseenter', function() {
            const rating = parseInt(this.dataset.rating);
            container.querySelectorAll('.star').forEach((s, index) => {
                if (index < rating) {
                    s.style.color = '#ffb733';
                } else {
                    s.style.color = '';
                }
            });
        });
        
        star.addEventListener('mouseleave', function() {
            container.querySelectorAll('.star').forEach(s => {
                s.style.color = '';
            });
        });
    });
}

// Color picker interaction
document.addEventListener('DOMContentLoaded', () => {
    // Setup color pickers for metadata modal
    document.querySelectorAll('#metadataModal .color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('#metadataModal .color-option').forEach(el => el.classList.remove('selected'));
            this.classList.add('selected');
            document.getElementById('metadataColor').value = this.dataset.color;
        });
    });
    
    // Close modals when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    };
});

// Initialize
fetchData();
setInterval(fetchData, 30000); // Auto-refresh every 30 seconds
</script>
</body>
</html>
